---
title: "INTERESTING SALAMANDER TITLE HERE"
author: "Cori Lopazanski, Kai Kopecky"
date: "11/22/2019"
output: 
  html_document:
    theme: paper
    toc: true
    toc_float: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE, warning = FALSE)
library(tidyverse)
library(janitor)
library(kableExtra)
library(ggbeeswarm)
library(ggridges)
library(ggjoy)
library(effsize)

salamander <- read_csv("mack_creek_vertebrates.csv") %>% 
  clean_names() %>% 
  filter(species == "DITE")
```

### Introduction

Amphibian populations have been declining for over half a century^1^, with more than 32% of global populations currently threatened^2^. Habitat loss and fragmentation are among the biggest threats to these fragile populations, which require particular temperatures and levels of moisture to survive^3^. Clear-cut logging, in particular, has been shown to increase sedimentation in streams, which negatively impacts larval amphibians^3^. Monitoring efforts have been implemented to assess how activities like clear-cutting affect salmonid populations, including the Aquatic Vertebrate Population Study within the H.J. Andrews Forest Long Term Ecological Research Program (HJA LTER), which monitors the threatened Pacific giant salamander (*Dicamptodon tenebrosus*) among other species. Here, we examine the distribution of Pacific giant salamanders in a section of forest that was clear-cut for logging in 1963 compared to a nearby 500 year old coniferous forest in Mack Creek, Oregon. Restoration efforts are sometimes used to attempt to convert habitats from a degraded state back to their pre-disturbance condition, typically by creating pools or increasing habitat complexity^4^. Understanding how the distribution of Pacific giant salamanders changes in different habitats can help guide restoration efforts. 

<iframe width="560" height="315" src="https://www.youtube.com/embed/mmm1Ml4sHE4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>



***
### Data and Methods
From Metadata: "Since 1987, we have been monitoring populations of West Slope cutthroat trout (Onchorhyncus clarki clarki) in two standard reaches of Mack Creek in the H.J. Andrews Experimental Forest. Beginning in 1993, we included monitoring of Pacific Giant Salamanders, Dicamptodon tenebrosus. The two standard reaches are in a section of clearcut forest (ca. 1963) and an upstream 500 year old coniferous forest. Sub-reaches are sampled with 2-pass electrofishing, and all captured vertebrates are measured and weighed. This study constitutes one of the longest continuous records of salmonid populations on record."

Site Code = coded name of sample area within Mack creek
Section = OG, old growth; CC, clear cut
Reach = reach sampled (in 50m distances); Lower (0-50), Middle (50-100), Upper (100-150)
Pass = electroshocking pass number
Unit Type = Cascade = C, Pool = P, Side-channel = SC, others (including IP = isolated pool)
Length 1 = snout to vent
Length 2 = snout to tail

### Results

#### A.

```{r}
# subset salamander dataframe to include only columns of interest and salamander counts for each year by forest section
salamander_abundance <- salamander %>% 
  select(year, section, species) %>% 
  mutate(species = ifelse(species == "DITE", 1, 0)) %>% 
  mutate(species = as.numeric(species)) %>% 
  mutate(section = ifelse(section == "OG", "Old Growth", "Clear Cut")) %>% 
  group_by(year, section) %>% 
  summarize(abundance = sum(species))
  
# Line plot showing salamander abundances from 1993 (start of monitoring) to present in both clear-cut and old growth forest sections
ggplot(data = salamander_abundance, aes(x = year, y = abundance))+
  geom_line(aes(color = section))+
  theme_classic()+
  theme(legend.position = c(0.2, 0.8)) +
  labs(x = "Year",
       y = "Salamander abundance",
       color = NULL)+
  scale_x_continuous(limits = c(1993, 2017),
                     breaks = c(seq(1993, 2017, by = 2)))+
  scale_y_continuous(limits = c(0, 400), expand = c(0,0))
  
``` 

***Figure 1.*** *Annual abundances of the Pacific Giant Salamander in two standard reaches of Mack Creek in the H. J. Andrews Experimental Forest from 1993 -2017. Salamanders were counted in a reach running through a section of old growth forest (blue line) and a section of historically clear-cut forest (red line).* 

Throughout 1993-2017, Giant Pacifc Salamander abundances observed in sections of old growth forest were consistently higher than in historically clear-cut sections of the H. J. Andrews Experimental Forest, with exceptions to this trend in 1994 and 2014 (Fig. 1). Both populations show a marked increase in abundance following 2001 and 2014, as well as a sharp decline in 2011.

#### B.

Table of 2017 salamander counts by channel classification (pool, cascades and side-channel) in old growth (OG) and clear cut (CC) sections of Mack Creek. 

Using only Pacific giant salamander observations from 2017, create a finalized table showing the counts and proportions of salamanders observed in different channel classifications (pool, cascade, or side-channel) within Mack Creek for the two sections (OG and CC). Add a table caption above the table. Note: Weâ€™re only interested in Pacific giant salamanders observed in the creek, so you should exclude salamanders observed in isolated pools (IP) disconnected from the channel. 

```{r}
count_creek_base <- salamander %>% 
  filter(year == "2017" & unittype %in% c("C", "P", "SC")) %>% # keep data in 2017, specific habitat types
  mutate( 
    unittype = case_when(
      unittype == "C" ~ "Cascade",
      unittype == "P" ~ "Pool",
      unittype == "SC" ~ "Side-Channel")) %>% 
  count(section, unittype) %>% 
  pivot_wider(names_from = section, values_from = n)

count_creek <- count_creek_base %>% 
  adorn_percentages(denominator = "col") %>% 
  adorn_pct_formatting(digits = 1) %>% 
  adorn_ns(position = "front")

kable(count_creek, col.names = c("", "Clear Cut", "Old Growth")) %>%
        kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = F,
                position = "float_right") %>% 
add_header_above(c("Table 1: Proportions of giant salamanders \nin different channel classifications \nobserved in two sections of Mack Creek" = 3))

```




#### C.

Another way to ask this: Regarding the locations where salamanders were observed in Mack Creek in 2017, is there a significant effect of forest condition (old growth or clear cut) on where in the channel salamanders are found (channel classification)? Report your statistical findings in text, in the context of the actual counts / proportions you present in the table. 

```{r}
# Is there a significant difference in where in the channel Pacific giant salamanders are located (pool, cascade or side channel) between the two sections (old growth and clear cut)? 
chi_count <- count_creek_base %>% 
  select(-unittype)

chi_count_result <- chisq.test(chi_count)
chi_count_result
```



#### D. 
```{r}
# Is there a significant difference in mean weights for Pacific giant salamanders observed in the two forest sections (clear cut and old growth) in 2017? 

salamander_weight <- salamander %>% 
  filter(year == "2017") %>% 
  select(section, weight) %>% 
  group_by(section) %>% 
  summarize(
    mean_wt = mean(weight, na.rm = TRUE),
    sd_wt = sd(weight, na.rm = TRUE),
    sample_size = n()
  )
```


#### E.

```{r}
# Comparison of salamander weights among habitat type
# First, create a dataframe for just weights and habitat type
salamander_habitat_2017 <- salamander %>% 
  filter(year == "2017") %>% 
  select(unittype, weight) %>% 
  filter(unittype != "IP") %>% 
  mutate(unittype = case_when(unittype == "C" ~ "Cascade",
                              unittype == "P" ~ "Pool",
                              unittype == "SC" ~ "Side-Channel"))

# Now create a summary table of mean weights and standard deviations by habitat type
salamander_weight_comparison <- salamander_habitat_2017 %>% 
  group_by(unittype) %>%
  summarize(
    mean_wt = mean(weight, na.rm = TRUE),
    sd_wt = sd(weight, na.rm = TRUE),
    sample_size = n(),
    se_wt = sd(weight / sqrt(sample_size), na.rm = TRUE))
  
# Violin plot with mean weights +/- standard error
ggplot()+
  geom_violin(data = salamander_habitat_2017, aes(x = unittype, y = weight, fill = unittype), alpha = 0.5, show.legend = FALSE)+
  geom_point(data = salamander_weight_comparison, aes(x = unittype, y = mean_wt))+
  geom_errorbar(data = salamander_weight_comparison, 
                aes(x = unittype,
                ymax = mean_wt + se_wt,
                ymin = mean_wt - se_wt),
                width = 0.1)+
  scale_y_continuous(limits = c(0, 90),
                     expand = c(0, 0),
                     breaks = c(seq(0, 90, by = 10)))+
  labs(x = "Channel unit",
       y = "Mean mass (g)",
       fill = NULL)+
  coord_flip()+
  theme_classic()

# Try it as a density plot 
#ggplot(salamander_habitat_2017, aes(x = weight, y = unittype, fill = unittype))+
 # geom_joy(data = filter(salamander_habitat_2017, unittype == "Side-Channel"), 
#           alpha = 0.4,   
#           scale = 0.9)+  
#  geom_joy(data = filter(salamander_habitat_2017, unittype == "Pool"), 
 #          alpha = 0.4, 
  #         scale = 0.9)+
#  geom_joy(data = filter(salamander_habitat_2017, unittype == "Cascade"), 
#           alpha = 0.4, 
#           scale = 0.9)+
#  theme_joy()+
#  theme_minimal()+
#  labs(x = "Channel unit",
#       y = "Mass (g)",
#       fill = NULL) 
# ... nope
```

***Figure 2. *** *Distributions for Giant Pacific Salamander mass (g) are displayed (violins) for habitat type, pooled for old growth and clear cut sections of forest. Mean masses (black dots) $\pm$ standard error (error bars) are displayed for each habitat type.*


```{r}
# Comaparison of mean weights using one-way ANOVA
habitat_mass_anova <- aov(weight ~ unittype, data = salamander_habitat_2017)
summary(habitat_mass_anova)
aov_outputs <- unlist(summary(habitat_mass_anova))

# Post hoc test to determine group differences
tukey_test <- TukeyHSD(habitat_mass_anova)
# Shows that Side-Channel and Pool are the only significantly different groups compared pairwise

# Dataframes for effect size calculations
salamander_side_channel_2017 <- salamander_habitat_2017 %>% 
  filter(unittype == "Side-Channel")

salamander_pool_2017 <- salamander_habitat_2017 %>% 
  filter(unittype == "Pool")

salamander_cascade_2017 <- salamander_habitat_2017 %>% 
  filter(unittype == "Cascade")

effect_size_habitat <- cohen.d(salamander_pool_2017$weight, salamander_side_channel_2017$weight)

# Means differences
mean_pool <- mean(salamander_pool_2017$weight)

mean_sc <- mean(salamander_side_channel_2017$weight)

mean_cascade <- mean(salamander_cascade_2017$weight, na.rm = TRUE)

mean_calculated <- mean_pool - mean_sc

# Percent differences
pct_diff <- ((mean_pool-mean_sc)/mean_sc)*100

# Standard errors for in-line referencing
se_pool <- salamander_pool_2017 %>% 
  summarize(sd(weight/sqrt(n())))

se_side_channel <- salamander_side_channel_2017 %>% 
  summarize(sd(weight/sqrt(n())))

se_cascade <- salamander_cascade_2017 %>% 
  summarize(sd(weight/sqrt(n()), na.rm = TRUE))
```

In 2017, mean weights of Giant Pacific Salamanders differed significantly between pools and side channels (one-way ANOVA with post-hoc Tukey's HSD: F$_{`r aov_outputs[1]`,`r aov_outputs[2]`}$ = `r round(aov_outputs[7],2)`, *p* = `r round(aov_outputs[9],3)`), while mean weights for individuals from cascades did not differ significantly from the other two habitat types (Fig. 2). The average weight for populations residing in pools (`r round(mean_pool, 2)` $\pm$ `r round(se_pool, 2)` g) was `r round(pct_diff, 2)`% more than that of populations observed in side-channels (`r round(mean_sc, 2)` $\pm$ `r round(se_side_channel, 2)` g). Due to large within group variation of salamander weights in each habitat type, an alternative metric -- population medians, for instance -- may lend to a more meaningful and accurate comparison across these groups.

There is a significant difference in mean weights for Pacific giant salamanders observed in the two forest sections (clear cut and old growth) in 2017

***
### Summary

- From 1993-2017, Giant Pacific Salamnder abundances were consistently higher in sections of old growth forest than histrocially clear cut sections of forest, apart from two years (Fig 1)
- In 2017, the mean weight of salamanders residing in pools was significantly greater than that of populations in side channels (Fig. 2)


***
### References

1. Houlahan, J., et al. "Quantitative evidence for global amphibian population declines." Nature 404 (2000): 752-755.

2. Stuart, S. N., et al. "Status and trends of amphibian declines and extinctions worldwide." Science 306 (2004): 1783-1786.

3. Johnston, B. and Frid, L. "Clearcut logging restricts the movements of terrestrial Pacific giant salamanders (Dicamptodon tenebrosus Good)" Canadian Journal of Zoology 80 (2011): 2170-2177.

4. IDK WHICH ONE IT IS CAUSE YOU CANT GET ACCESS OFF CAMPUS WHICH IS DUMB SO GUESS ILLL DO IT TOMORROW

5. Gregory S. V. 2016. Aquatic Vertebrate Population Study in Mack Creek, Andrews Experimental Forest, 1987 to present. Environmental Data Initiative. https://doi.org/10.6073/pasta/5de64af9c11579266ef20da2ff32f702. Dataset accessed 11/19/2019.


